<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head}">
    <title>Заказы - Админ панель</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Анимация для модального окна */
        #imageModal {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Стили для изображений */
        .order-image {
            transition: transform 0.2s ease;
        }

        .order-image:hover {
            transform: scale(1.05);
        }

        /* Скрытие скроллбара при просмотре изображения */
        .max-h-\[80vh\] {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .max-h-\[80vh\]::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body>
<div th:replace="~{admin/layout :: header}"></div>

<div class="flex">
    <div th:replace="~{admin/layout :: aside}"></div>

    <main class="flex-1 p-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Управление заказами</h1>
            <p class="text-gray-600">Просмотр и управление всеми заказами</p>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                    <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">Все статусы</option>
                        <option value="PENDING">В ожидании</option>
                        <option value="PROCESSING">В обработке</option>
                        <option value="COMPLETED">Завершен</option>
                        <option value="CANCELLED">Отменен</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Дата от</label>
                    <input type="date" id="dateFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Дата до</label>
                    <input type="date" id="dateTo" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Применить
                    </button>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b">
                <h2 class="text-lg font-semibold">Список заказов</h2>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">ID</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Телефон</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Сумма</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Статус</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Дата</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Действия</th>
                        </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="pagination" class="mt-4 flex justify-between items-center">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Order Details Modal -->
<div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Детали заказа #<span id="modalOrderId"></span></h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="orderDetails">
            <!-- Order details will be loaded here -->
        </div>
    </div>
</div>

<script>

    let currentPage = 0;
    const pageSize = 10;

    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
    });

// Функция для безопасного отображения изображения
function getSafeImageUrl(fileName) {
    console.log('Original fileName:', fileName);

    if (!fileName) {
        return '';
    }

    // Если fileName уже полный URL, возвращаем как есть
    if (fileName.startsWith('http')) {
        return fileName;
    }

    // Извлекаем только имя файла из пути
    let cleanFileName = fileName;
    if (fileName.includes('/')) {
        cleanFileName = fileName.substring(fileName.lastIndexOf('/') + 1);
    }

    // Кодируем имя файла для безопасной передачи в URL
    cleanFileName = encodeURIComponent(cleanFileName);

    return `/api/files/${cleanFileName}`;
}

// Улучшенная функция проверки существования файла
async function checkFileExists(fileName) {
    try {
        // Очищаем имя файла от путей
        let cleanFileName = fileName;
        if (fileName.includes('/')) {
            cleanFileName = fileName.substring(fileName.lastIndexOf('/') + 1);
        }

        console.log('Checking file existence:', cleanFileName);

        const response = await fetch(`/api/files/exists/${cleanFileName}`);
        if (response.ok) {
            const exists = await response.json();
            console.log('File exists:', exists, 'for:', cleanFileName);
            return exists;
        }
        return false;
    } catch (error) {
        console.error('Error checking file existence:', error);
        return false;
    }
}

    async function loadOrders(page = 0) {
        try {
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            let url = `/api/admin/orders?page=${page}&size=${pageSize}`;
            if (status) url += `&status=${status}`;
            if (dateFrom) url += `&dateFrom=${dateFrom}`;
            if (dateTo) url += `&dateTo=${dateTo}`;

            const response = await fetch(url);
            const data = await response.json();

            displayOrders(data.content);
            displayPagination(data);
            currentPage = page;
        } catch (error) {
            console.error('Error loading orders:', error);
        }
    }

 function displayOrderDetails(order) {
    console.log('Displaying order details - full order data:', order);

    const safeOrder = {
        id: order?.id || 'N/A',
        customerEmail: order?.customerEmail || 'Не указан',
        customerPhone: order?.customerPhone || 'Не указан',
        status: order?.status || 'UNKNOWN',
        totalAmount: order?.totalAmount || 0,
        discountAmount: order?.discountAmount || 0,
        couponCode: order?.couponCode || null,
        createdAt: order?.createdAt || new Date().toISOString(),
        items: Array.isArray(order?.items) ? order.items.map(item => ({
            serviceName: item?.serviceName || 'Услуга не найдена',
            sizeName: item?.sizeName || 'N/A',
            dimensions: item?.dimensions || 'N/A',
            price: item?.price || 0,
            quantity: item?.quantity || 1,
            photoUrl: item?.photoUrl || null,
            itemTotal: item?.itemTotal || 0,
            fileExists: item?.fileExists || false
        })) : []
    };

    const orderDetailsHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h4 class="font-bold mb-2">Информация о клиенте</h4>
                <p><strong>Email:</strong> ${safeOrder.customerEmail}</p>
                <p><strong>Телефон:</strong> ${safeOrder.customerPhone}</p>
            </div>
            <div>
                <h4 class="font-bold mb-2">Информация о заказе</h4>
                <p><strong>Статус:</strong> ${getStatusText(safeOrder.status)}</p>
                <p><strong>Дата создания:</strong> ${new Date(safeOrder.createdAt).toLocaleString()}</p>
                <p><strong>Общая сумма:</strong> ${safeOrder.totalAmount} ₽</p>
                ${safeOrder.discountAmount > 0 ? `<p><strong>Скидка:</strong> ${safeOrder.discountAmount} ₽</p>` : ''}
                ${safeOrder.couponCode ? `<p><strong>Промокод:</strong> ${safeOrder.couponCode}</p>` : ''}
            </div>
        </div>
        <div>
            <h4 class="font-bold mb-2">Услуги</h4>
            <div class="space-y-4">
                ${safeOrder.items.length > 0 ? safeOrder.items.map(item => `
                    <div class="border rounded p-4 bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-2">
                                <p><strong>Услуга:</strong> ${item.serviceName}</p>
                                <p><strong>Размер:</strong> ${item.sizeName}</p>
                                <p><strong>Параметры:</strong> ${item.dimensions}</p>
                                <p><strong>Количество:</strong> ${item.quantity}</p>
                                <p><strong>Цена за шт:</strong> ${item.price} ₽</p>
                                <p><strong>Итого за позицию:</strong> ${item.itemTotal} ₽</p>
                                ${item.photoUrl ? `
                                    <div class="mt-2">
                                        <p><strong>Файл:</strong> ${item.photoUrl}</p>
                                        <p class="text-sm ${item.fileExists ? 'text-green-600' : 'text-red-600'}">
                                            ${item.fileExists ? '✓ Файл доступен' : '✗ Файл не найден'}
                                        </p>
                                        ${item.fileExists ? `
                                            <div class="flex space-x-2 mt-2">
                                                <button onclick="viewImage('${item.photoUrl}')"
                                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                                    Просмотреть
                                                </button>
                                                <button onclick="downloadImage('${item.photoUrl}')"
                                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                                    Скачать
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : '<p class="text-red-500">Фото не загружено</p>'}
                            </div>
                            ${item.photoUrl && item.fileExists ? `
                                <div class="flex justify-center">
                                    <img src="${getSafeImageUrl(item.photoUrl)}"
                                         alt="Загруженное фото"
                                         class="max-w-full h-32 object-cover rounded border cursor-pointer order-image"
                                         onclick="viewImage('${item.photoUrl}')"
                                         onerror="this.src='/assets/image-not-found.png'; this.onclick=null; this.classList.remove('cursor-pointer')">
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-500">Услуги не найдены</p>'}
            </div>
        </div>
    `;

    document.getElementById('orderDetails').innerHTML = orderDetailsHtml;
}

   function displayOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Заказы не найдены</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3">#${order.id}</td>
            <td class="px-4 py-3">${order.customerEmail || 'Не указан'}</td>
            <td class="px-4 py-3">${order.customerPhone || 'Не указан'}</td>
            <td class="px-4 py-3 font-bold">${order.totalAmount || 0} ₽</td>
            <td class="px-4 py-3">
                <span class="inline-block px-2 py-1 text-xs rounded ${
                    order.status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                    order.status === 'PROCESSING' ? 'bg-blue-100 text-blue-800' :
                    order.status === 'COMPLETED' ? 'bg-green-100 text-green-800' :
                    'bg-red-100 text-red-800'
                }">${getStatusText(order.status)}</span>
            </td>
            <td class="px-4 py-3">${new Date(order.createdAt).toLocaleDateString()}</td>
            <td class="px-4 py-3">
                <div class="flex space-x-2">
                    <button onclick="viewOrder(${order.id})"
                            class="text-blue-600 hover:text-blue-800 p-2 rounded hover:bg-blue-50 transition duration-200"
                            title="Просмотреть детали">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="updateOrderStatus(${order.id})"
                            class="text-green-600 hover:text-green-800 p-2 rounded hover:bg-green-50 transition duration-200"
                            title="Изменить статус">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

    function displayPagination(data) {
        const pagination = document.getElementById('pagination');
        const totalPages = data.totalPages;

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHtml = `
            <div class="text-sm text-gray-700">
                Показано ${data.number * data.size + 1}-${Math.min((data.number + 1) * data.size, data.totalElements)} из ${data.totalElements}
            </div>
            <div class="flex space-x-2">
        `;

        if (data.number > 0) {
            paginationHtml += `<button onclick="loadOrders(${data.number - 1})" class="px-3 py-1 border rounded">Назад</button>`;
        }

        for (let i = 0; i < totalPages; i++) {
            if (i === data.number) {
                paginationHtml += `<span class="px-3 py-1 bg-blue-600 text-white rounded">${i + 1}</span>`;
            } else {
                paginationHtml += `<button onclick="loadOrders(${i})" class="px-3 py-1 border rounded">${i + 1}</button>`;
            }
        }

        if (data.number < totalPages - 1) {
            paginationHtml += `<button onclick="loadOrders(${data.number + 1})" class="px-3 py-1 border rounded">Вперед</button>`;
        }

        paginationHtml += '</div>';
        pagination.innerHTML = paginationHtml;
    }

    function getStatusText(status) {
        const statusMap = {
            'PENDING': 'В ожидании',
            'PROCESSING': 'В обработке',
            'COMPLETED': 'Завершен',
            'CANCELLED': 'Отменен'
        };
        return statusMap[status] || status;
    }

    function applyFilters() {
        loadOrders(0);
    }

 async function viewOrder(orderId) {
    try {
        console.log('Loading order details for ID:', orderId);
        const response = await fetch(`/api/admin/orders/${orderId}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const order = await response.json();
        console.log('Order data loaded:', order);

        document.getElementById('modalOrderId').textContent = orderId;

        // Проверяем существование файлов для каждого элемента
        const itemsWithFileInfo = await Promise.all(
            (order.items || []).map(async (item) => {
                if (item.photoUrl) {
                    const fileExists = await checkFileExists(item.photoUrl);
                    return {
                        ...item,
                        fileExists,
                        // Добавляем безопасные значения для service
                        safeService: item.service || {
                            name: 'Услуга не найдена',
                            dimensions: 'N/A',
                            price: 0
                        }
                    };
                }
                return {
                    ...item,
                    fileExists: false,
                    safeService: item.service || {
                        name: 'Услуга не найдена',
                        dimensions: 'N/A',
                        price: 0
                    }
                };
            })
        );

        // Создаем безопасный объект заказа
        const safeOrder = {
            ...order,
            items: itemsWithFileInfo
        };

        // Используем безопасную функцию для отображения
        displayOrderDetails(safeOrder);

        document.getElementById('orderModal').classList.remove('hidden');
        document.getElementById('orderModal').classList.add('flex');
    } catch (error) {
        console.error('Error loading order details:', error);
        document.getElementById('orderDetails').innerHTML = `
            <div class="text-center text-red-600 py-4">
                Ошибка загрузки данных: ${error.message}
            </div>
        `;
        document.getElementById('orderModal').classList.remove('hidden');
        document.getElementById('orderModal').classList.add('flex');
    }
}

    async function updateOrderStatus(orderId) {
    const statusMap = {
        'PENDING': 'В ожидании',
        'PROCESSING': 'В обработке',
        'COMPLETED': 'Завершен',
        'CANCELLED': 'Отменен'
    };

    const statusOptions = Object.entries(statusMap).map(([value, text]) =>
        `<option value="${value}">${text}</option>`
    ).join('');

    const newStatus = prompt(`Введите новый статус для заказа #${orderId}:\n\n${Object.entries(statusMap).map(([key, value]) => `${key} - ${value}`).join('\n')}`);

    if (newStatus && ['PENDING', 'PROCESSING', 'COMPLETED', 'CANCELLED'].includes(newStatus.toUpperCase())) {
        try {
            const response = await fetch(`/api/admin/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus.toUpperCase() })
            });

            if (response.ok) {
                alert('Статус заказа успешно обновлен');
                loadOrders(currentPage);
            } else {
                const errorText = await response.text();
                alert('Ошибка при обновлении статуса: ' + errorText);
            }
        } catch (error) {
            console.error('Error updating order status:', error);
            alert('Ошибка при обновлении статуса: ' + error.message);
        }
    } else if (newStatus) {
        alert('Неверный статус. Допустимые значения: PENDING, PROCESSING, COMPLETED, CANCELLED');
    }
}

  function viewImage(fileName) {
    const imageUrl = getSafeImageUrl(fileName);
    console.log('Viewing image - original:', fileName, 'resolved:', imageUrl);

    // Закрываем предыдущее модальное окно если есть
    const existingModal = document.getElementById('imageModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Создаем новое модальное окно
    const modalHtml = `
        <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 max-w-4xl max-h-[90vh] mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Просмотр изображения</h3>
                    <button onclick="closeImageModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                        &times;
                    </button>
                </div>
                <div class="overflow-auto max-h-[80vh] flex justify-center">
                    <img src="${imageUrl}"
                         alt="Просмотр изображения"
                         class="max-w-full max-h-full"
                         onerror="handleImageError(this)">
                </div>
                <div class="mt-4 flex justify-between">
                    <a href="${imageUrl}" download="${fileName}"
                       class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 no-underline">
                        Скачать
                    </a>
                    <button onclick="closeImageModal()"
                            class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Функция обработки ошибок загрузки изображения
function handleImageError(img) {
    console.error('Failed to load image:', img.src);

    // Создаем SVG иконку "изображение не найдено"
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjOTk5Ij7QndC10YIg0LjRgtCw0LvRjNGP0L3RizwvdGV4dD4KPC9zdmc+';
    img.onerror = null;
    img.classList.remove('cursor-pointer');

    const errorDiv = document.createElement('div');
    errorDiv.className = 'text-red-500 text-center mt-2';
    errorDiv.textContent = 'Не удалось загрузить изображение';
    img.parentNode.appendChild(errorDiv);
}

// Функция для закрытия модального окна изображения
function closeImageModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.remove();
    }
}

// Функция для скачивания изображения
function downloadImage(fileName) {
    const downloadUrl = getSafeImageUrl(fileName);
    console.log('Downloading image:', fileName, 'URL:', downloadUrl);

    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName.includes('/') ? fileName.substring(fileName.lastIndexOf('/') + 1) : fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Закрытие модального окна по ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});

// Закрытие модального окна по клику на фон
document.addEventListener('click', function(event) {
    if (event.target.id === 'imageModal') {
        closeImageModal();
    }
});

    function closeModal() {
        document.getElementById('orderModal').classList.add('hidden');
        document.getElementById('orderModal').classList.remove('flex');
    }

</script>
</body>
</html>