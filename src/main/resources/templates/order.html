<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
    <title>–ó–∞–∫–∞–∑ –ø–µ—á–∞—Ç–∏ - PhotoPrint</title>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center mb-8">–ó–∞–∫–∞–∑ –ø–µ—á–∞—Ç–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h1>

    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <!-- –í —Ä–∞–∑–¥–µ–ª–µ "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ" -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">1. –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
            <div id="photosContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <!-- –§–æ—Ç–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            <div class="flex gap-2">
                <input type="file" id="photoUpload" multiple accept="image/*" class="hidden">
                <button type="button" onclick="document.getElementById('photoUpload').click()"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    + –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∫ –æ–¥–Ω–æ–º—É –∑–∞–∫–∞–∑—É</p>
        </div>

        <!-- –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º" –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">2. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
                <button type="button" onclick="addMorePhotos()"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
                    üì∑ –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ñ–æ—Ç–æ
                </button>
            </div>

            <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥ -->
            <div id="servicesSelectionContainer" class="space-y-4">
                <!-- –§–æ—Ç–æ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ä—è–¥ -->
            </div>
        </div>

        <!-- Customer Info -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div id="authMessage"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="customerEmail" required
                           th:value="${userEmail != null ? userEmail : ''}"
                           th:readonly="${userEmail != null}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input type="tel" id="customerPhone" required
                           th:value="${userPhone != null ? userPhone : ''}"
                           th:readonly="${userPhone != null}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- –°–∫–∏–¥–æ—á–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">–°–∫–∏–¥–æ—á–Ω–∞—è –∫–∞—Ä—Ç–∞</h2>
            <div class="flex gap-2">
                <input type="text" id="discountCardCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤–∞—à–µ–π –∫–∞—Ä—Ç—ã (XXXX-XXXX-XXXX)"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="button" onclick="applyDiscountCard()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
            <div id="cardMessage" class="mt-2 text-sm"></div>

            <!-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –ø–æ–∫–∞–∑–∞—Ç—å –∏—Ö –∫–∞—Ä—Ç—ã -->
            <div id="userCards" class="mt-4 hidden">
                <h3 class="font-semibold mb-2">–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</h3>
                <div id="cardsList"></div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</h2>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥:</span>
                    <span id="subtotal">0 ‚ÇΩ</span>
                </div>
                <div class="flex justify-between text-green-600">
                    <span>–°–∫–∏–¥–∫–∞:</span>
                    <span id="discount">0 ‚ÇΩ</span>
                </div>
                <div class="flex justify-between text-xl font-bold border-t pt-2">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="total">0 ‚ÇΩ</span>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="button" onclick="submitOrder()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-300">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>
</div>

<script>
    let uploadedPhotos = [];
    let availableServices = [];
    let appliedDiscountCard = null;
    let appliedCoupon = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥
    async function loadServices() {
        try {
            const response = await fetch('/api/services/active');
            availableServices = await response.json();
        } catch (error) {
            console.error('Error loading services:', error);
            availableServices = [];
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
  document.getElementById('photoUpload').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);

    if (files.length === 0) return;

    if (uploadedPhotos.length + files.length > 50) {
        alert(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ –≤ –æ–¥–Ω–æ–º –∑–∞–∫–∞–∑–µ: 50. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë ${50 - uploadedPhotos.length} —Ñ–æ—Ç–æ.`);
        e.target.value = '';
        return;
    }

    files.forEach(file => {
        if (!file.type.startsWith('image/')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB`);
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            uploadedPhotos.push({
                id: photoId,
                file: file,
                previewUrl: e.target.result,
                services: [] // –ù–æ–≤—ã–µ —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥
            });

            updatePhotosDisplay();
            updateServicesSelection();
            // –£–ë–ò–†–ê–ï–ú –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: applyLastServicesToNewPhotos();
        };
        reader.readAsDataURL(file);
    });

    e.target.value = '';
});

function copyServicesToAllPhotos(sourcePhotoId) {
    const sourcePhoto = uploadedPhotos.find(p => p.id === sourcePhotoId);
    if (!sourcePhoto || sourcePhoto.services.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º');
        return;
    }

    // –ö–æ–ø–∏—Ä—É–µ–º —É—Å–ª—É–≥–∏ –Ω–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ
    uploadedPhotos.forEach(photo => {
        if (photo.id !== sourcePhotoId) {
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —É—Å–ª—É–≥–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            photo.services = sourcePhoto.services.map(service => ({
                serviceId: service.serviceId,
                serviceName: service.serviceName,
                serviceSizeId: service.serviceSizeId,
                sizeName: service.sizeName,
                price: service.price,
                quantity: service.quantity
            }));
        }
    });

    updateServicesSelection();
    updatePhotosDisplay();
    calculateTotal();

    alert(`–£—Å–ª—É–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å "${sourcePhoto.file.name}" –Ω–∞ –≤—Å–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏!`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ª—É–≥ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
function copyServicesToSelectedPhotos(sourcePhotoId) {
    const sourcePhoto = uploadedPhotos.find(p => p.id === sourcePhotoId);
    if (!sourcePhoto || sourcePhoto.services.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º');
        return;
    }

    // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥
    const photosWithoutServices = uploadedPhotos.filter(photo =>
        photo.id !== sourcePhotoId && photo.services.length === 0
    );

    if (photosWithoutServices.length === 0) {
        alert('–ù–µ—Ç —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
    }

    // –ö–æ–ø–∏—Ä—É–µ–º —É—Å–ª—É–≥–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥
    photosWithoutServices.forEach(photo => {
        photo.services = sourcePhoto.services.map(service => ({
            serviceId: service.serviceId,
            serviceName: service.serviceName,
            serviceSizeId: service.serviceSizeId,
            sizeName: service.sizeName,
            price: service.price,
            quantity: service.quantity
        }));
    });

    updateServicesSelection();
    updatePhotosDisplay();
    calculateTotal();

    alert(`–£—Å–ª—É–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å "${sourcePhoto.file.name}" –Ω–∞ ${photosWithoutServices.length} —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥!`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function setQuickQuantity(photoId, quantity) {
    const quantityInput = document.getElementById(`quantity-input-${photoId}`);
    if (quantityInput) {
        quantityInput.value = quantity;
        quantityInput.focus();
    }
}

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
    function updatePhotosDisplay() {
        const container = document.getElementById('photosContainer');
        container.innerHTML = '';

        if (uploadedPhotos.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
                </div>
            `;
            return;
        }

        uploadedPhotos.forEach(photo => {
            const servicesCount = photo.services.length;
            const hasServices = servicesCount > 0;

            const photoHtml = `
                <div class="border rounded-lg p-3 photo-item ${hasServices ? 'border-green-200 bg-green-50' : 'border-gray-200'}"
                     data-photo-id="${photo.id}">
                    <div class="relative">
                        <img src="${photo.previewUrl}" class="w-full h-32 object-cover rounded">
                        <button type="button" onclick="removePhoto('${photo.id}')"
                                class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-700">
                            √ó
                        </button>
                        ${hasServices ? `
                            <div class="absolute top-1 left-1 bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                ‚úì
                            </div>
                        ` : ''}
                    </div>
                    <div class="mt-2 text-sm text-gray-600 truncate" title="${photo.file.name}">
                        ${photo.file.name}
                    </div>
                    <div class="mt-1 text-xs ${hasServices ? 'text-green-600 font-semibold' : 'text-gray-500'}">
                        ${hasServices ? `–£—Å–ª—É–≥: ${servicesCount}` : '–£—Å–ª—É–≥–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã'}
                    </div>
                    <div class="mt-1 text-xs text-gray-400">
                        ${(photo.file.size / 1024 / 1024).toFixed(1)} MB
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', photoHtml);
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ
    function removePhoto(photoId) {
        uploadedPhotos = uploadedPhotos.filter(photo => photo.id !== photoId);
        updatePhotosDisplay();
        updateServicesSelection();
        calculateTotal();
    }

   // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥
function updateServicesSelection() {
    const container = document.getElementById('servicesSelectionContainer');

    if (uploadedPhotos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p>–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—ã—à–µ</p>
            </div>
        `;
        return;
    }

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4" id="photosGridContainer">
            ${uploadedPhotos.map(photo => `
                <div class="border rounded-lg p-3 photo-services compact-view" data-photo-id="${photo.id}">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ç–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <img src="${photo.previewUrl}" class="w-10 h-10 object-cover rounded">
                            <div class="min-w-0 flex-1">
                                <h3 class="font-semibold text-sm truncate" title="${photo.file.name}">${photo.file.name}</h3>
                                <div class="text-xs text-gray-500">
                                    ${photo.services.length > 0 ? `${photo.services.length} —É—Å–ª—É–≥` : '–ù–µ—Ç —É—Å–ª—É–≥'}
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button type="button" onclick="copyServicesToAllPhotos('${photo.id}')"
                                    class="bg-blue-600 text-white p-1 rounded hover:bg-blue-700 text-xs"
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—Å–µ —Ñ–æ—Ç–æ">
                                üìã –í—Å–µ
                            </button>
                            <button type="button" onclick="copyServicesToSelectedPhotos('${photo.id}')"
                                    class="bg-purple-600 text-white p-1 rounded hover:bg-purple-700 text-xs"
                                    title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ñ–æ—Ç–æ –±–µ–∑ —É—Å–ª—É–≥">
                                üìã –ù–æ–≤—ã–µ
                            </button>
                        </div>
                    </div>

                    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–æ) -->
                    <div class="services-list mb-3 max-h-32 overflow-y-auto" id="services-list-${photo.id}">
                        ${renderSelectedServicesCompact(photo)}
                    </div>

                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥ -->
                    <div class="space-y-2">
                        <select id="service-select-${photo.id}"
                                onchange="onServiceSelected('${photo.id}')"
                                class="service-select w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É...</option>
                            ${renderServiceOptions()}
                        </select>

                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ - –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç -->
                        <div id="quantity-container-${photo.id}" class="hidden">
                            <div class="space-y-2">
                                <div class="flex gap-2 items-center">
                                    <label class="text-sm text-gray-600 whitespace-nowrap">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                    <input type="number" id="quantity-input-${photo.id}"
                                           class="quantity-input flex-1 px-2 py-1 border border-gray-300 rounded-md text-sm"
                                           min="1" value="1" placeholder="–ö–æ–ª-–≤–æ">
                                    <button type="button" onclick="addServiceToPhoto('${photo.id}')"
                                            class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </button>
                                </div>
                                <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤ -->
                                <div class="flex gap-1 justify-center">
                                    <button type="button" onclick="setQuickQuantity('${photo.id}', 1)" class="bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300">1</button>
                                    <button type="button" onclick="setQuickQuantity('${photo.id}', 2)" class="bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300">2</button>
                                    <button type="button" onclick="setQuickQuantity('${photo.id}', 5)" class="bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300">5</button>
                                    <button type="button" onclick="setQuickQuantity('${photo.id}', 10)" class="bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300">10</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Enter –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    setTimeout(() => {
        uploadedPhotos.forEach(photo => {
            const quantityInput = document.getElementById(`quantity-input-${photo.id}`);
            if (quantityInput) {
                quantityInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addServiceToPhoto(photo.id);
                    }
                });
            }

            const select = document.getElementById(`service-select-${photo.id}`);
            if (select) {
                select.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && select.value) {
                        onServiceSelected(photo.id);
                    }
                });
            }
        });
    }, 0);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
function onServiceSelected(photoId) {
    const select = document.getElementById(`service-select-${photoId}`);
    const quantityContainer = document.getElementById(`quantity-container-${photoId}`);

    if (!select.value) {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø—É—Å—Ç–∞—è –æ–ø—Ü–∏—è - —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        quantityContainer.classList.add('hidden');
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —É—Å–ª—É–≥–∏
    quantityContainer.classList.remove('hidden');

    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    setTimeout(() => {
        const quantityInput = document.getElementById(`quantity-input-${photoId}`);
        if (quantityInput) {
            quantityInput.focus();
            quantityInput.select();
        }
    }, 100);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ —Å–ø–∏—Å–∫–∞
function addServiceOnSelect(photoId) {
    const select = document.getElementById(`service-select-${photoId}`);

    if (!select.value) return; // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø—É—Å—Ç–∞—è –æ–ø—Ü–∏—è

    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —É—Å–ª—É–≥–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
    const selectedOption = select.options[select.selectedIndex];
    const serviceData = {
        serviceId: parseInt(selectedOption.dataset.serviceId),
        serviceName: selectedOption.dataset.serviceName,
        serviceSizeId: parseInt(selectedOption.dataset.sizeId),
        sizeName: selectedOption.dataset.sizeName,
        price: parseFloat(selectedOption.dataset.price),
        quantity: 1 // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 1
    };

    const photo = uploadedPhotos.find(p => p.id === photoId);
    if (photo) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ —É—Å–ª—É–≥–∞
        const isAlreadyAdded = photo.services.some(service =>
            service.serviceSizeId === serviceData.serviceSizeId
        );

        if (isAlreadyAdded) {
            alert('–≠—Ç–∞ —É—Å–ª—É–≥–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ñ–æ—Ç–æ');
            select.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            return;
        }

        photo.services.push(serviceData);
        updateServicesSelection();
        updatePhotosDisplay();
        calculateTotal();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        select.value = '';
    }
}

    // –†–µ–Ω–¥–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –¥–ª—è —Ñ–æ—Ç–æ
 function renderSelectedServicesCompact(photo) {
    if (photo.services.length === 0) {
        return '<div class="text-gray-400 text-xs text-center py-2">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥</div>';
    }

    return photo.services.map(service => `
        <div class="flex items-center justify-between bg-gray-50 p-2 rounded mb-1 text-xs">
            <div class="min-w-0 flex-1">
                <div class="font-medium truncate">${service.serviceName}</div>
                <div class="text-gray-600 truncate">
                    ${service.sizeName} √ó${service.quantity}
                </div>
            </div>
            <div class="flex items-center gap-2 ml-2">
                <span class="font-semibold whitespace-nowrap">${(service.price * service.quantity).toFixed(0)} ‚ÇΩ</span>
                <button type="button" onclick="removeServiceFromPhoto('${photo.id}', '${service.serviceSizeId}')"
                        class="text-red-600 hover:text-red-800 text-xs">
                    √ó
                </button>
            </div>
        </div>
    `).join('');
}


   // –†–µ–Ω–¥–µ—Ä –æ–ø—Ü–∏–π —É—Å–ª—É–≥
function renderServiceOptions() {
    let options = '';
    availableServices.forEach(service => {
        if (service.sizes && service.sizes.length > 0) {
            service.sizes.forEach(size => {
                if (size.active) {
                    options += `<option value="${service.id}_${size.id}"
                                  data-service-id="${service.id}"
                                  data-service-name="${service.name}"
                                  data-size-id="${size.id}"
                                  data-size-name="${size.sizeName}"
                                  data-price="${size.price}">
                        ${service.name} - ${size.sizeName} (${size.price} ‚ÇΩ)
                    </option>`;
                }
            });
        }
    });
    return options;
}


   // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
function addServiceToPhoto(photoId) {
    const select = document.getElementById(`service-select-${photoId}`);
    const quantityInput = document.getElementById(`quantity-input-${photoId}`);
    const quantityContainer = document.getElementById(`quantity-container-${photoId}`);

    if (!select.value) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É');
        return;
    }

    const quantity = parseInt(quantityInput.value) || 1;
    if (quantity < 1) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1');
        return;
    }

    const selectedOption = select.options[select.selectedIndex];
    const serviceData = {
        serviceId: parseInt(selectedOption.dataset.serviceId),
        serviceName: selectedOption.dataset.serviceName,
        serviceSizeId: parseInt(selectedOption.dataset.sizeId),
        sizeName: selectedOption.dataset.sizeName,
        price: parseFloat(selectedOption.dataset.price),
        quantity: quantity
    };

    const photo = uploadedPhotos.find(p => p.id === photoId);
    if (photo) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ —ç—Ç–∞ —É—Å–ª—É–≥–∞
        const existingServiceIndex = photo.services.findIndex(service =>
            service.serviceSizeId === serviceData.serviceSizeId
        );

        if (existingServiceIndex !== -1) {
            // –ï—Å–ª–∏ —É—Å–ª—É–≥–∞ —É–∂–µ –µ—Å—Ç—å - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            photo.services[existingServiceIndex].quantity += quantity;
        } else {
            // –ï—Å–ª–∏ —É—Å–ª—É–≥–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
            photo.services.push(serviceData);
        }

        updateServicesSelection();
        updatePhotosDisplay();
        calculateTotal();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        select.value = '';
        quantityInput.value = '1';
        quantityContainer.classList.add('hidden');
    }
}

    // –£–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ —Å —Ñ–æ—Ç–æ
    function removeServiceFromPhoto(photoId, serviceSizeId) {
        const photo = uploadedPhotos.find(p => p.id === photoId);
        if (photo) {
            photo.services = photo.services.filter(s => s.serviceSizeId.toString() !== serviceSizeId);
            updateServicesSelection();
            updatePhotosDisplay();
            calculateTotal();
        }
    }

    // –ü–µ—Ä–µ—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
    function calculateTotal() {
        let subtotal = 0;

        uploadedPhotos.forEach(photo => {
            photo.services.forEach(service => {
                subtotal += service.price * service.quantity;
            });
        });

        let discount = 0;
        if (appliedDiscountCard) {
            if (appliedDiscountCard.discountType === 'PERCENTAGE') {
                discount = subtotal * (appliedDiscountCard.discountValue / 100);
            } else if (appliedDiscountCard.discountType === 'FIXED') {
                discount = Math.min(subtotal, appliedDiscountCard.discountValue);
            }
        }

        const total = Math.max(0, subtotal - discount);

        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('discount').textContent = discount.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('total').textContent = total.toFixed(2) + ' ‚ÇΩ';

        return { subtotal, discount, total };
    }

   // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∫–∏–¥–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç
async function applyDiscountCard() {
    const cardCode = document.getElementById('discountCardCode').value.trim();
    const messageDiv = document.getElementById('cardMessage');

    if (!cardCode) {
        messageDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç—ã (XXXX-XXXX-XXXX)
    const cardFormat = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
    if (!cardFormat.test(cardCode)) {
        messageDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: XXXX-XXXX-XXXX';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        return;
    }

    messageDiv.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç—É...';
    messageDiv.className = 'mt-2 text-sm text-blue-600';

    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
        const totals = calculateTotal();
        const orderAmount = totals.subtotal;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint
        const response = await fetch(`/api/discount-cards/${encodeURIComponent(cardCode)}/validate?orderAmount=${orderAmount}`);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—Ä—Ç—ã');
        }

        const result = await response.json();

        if (result.valid) {
            appliedDiscountCard = {
                code: result.card.code,
                cardName: result.card.cardName,
                discountType: result.card.discountType,
                discountValue: result.card.discountValue,
                minOrderAmount: result.card.minOrderAmount
            };

            messageDiv.textContent = result.message || `–ö–∞—Ä—Ç–∞ "${result.card.cardName}" –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! –°–∫–∏–¥–∫–∞: ${result.card.discountType === 'PERCENTAGE' ? result.card.discountValue + '%' : result.card.discountValue + ' ‚ÇΩ'}`;
            messageDiv.className = 'mt-2 text-sm text-green-600';
            calculateTotal();
        } else {
            appliedDiscountCard = null;
            messageDiv.textContent = result.message || '–ö–∞—Ä—Ç–∞ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞';
            messageDiv.className = 'mt-2 text-sm text-red-600';
            calculateTotal();
        }
    } catch (error) {
        console.error('Error applying discount card:', error);
        appliedDiscountCard = null;
        messageDiv.textContent = error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–∞—Ä—Ç—ã';
        messageDiv.className = 'mt-2 text-sm text-red-600';
        calculateTotal();
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserCards() {
    try {
        const response = await fetch('/api/discount-cards/my-active');
        if (response.ok) {
            const userCards = await response.json();
            if (userCards.length > 0) {
                const userCardsDiv = document.getElementById('userCards');
                const cardsListDiv = document.getElementById('cardsList');

                userCardsDiv.classList.remove('hidden');
                cardsListDiv.innerHTML = '';

                userCards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'bg-gray-100 p-3 rounded mb-2 cursor-pointer hover:bg-gray-200';
                    cardElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <strong>${card.cardName}</strong>
                                <div class="text-sm text-gray-600">${card.code}</div>
                                <div class="text-sm">
                                    –°–∫–∏–¥–∫–∞: ${card.discountType === 'PERCENTAGE' ? card.discountValue + '%' : card.discountValue + ' ‚ÇΩ'}
                                </div>
                            </div>
                            <button type="button" onclick="applyUserCard('${card.code}')"
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    `;
                    cardsListDiv.appendChild(cardElement);
                });
            }
        }
    } catch (error) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
    }
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function applyUserCard(cardCode) {
    document.getElementById('discountCardCode').value = cardCode;
    applyDiscountCard();
}

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   async function loadUserProfile() {
    try {
        const response = await fetch('/api/user/profile');
        if (response.ok) {
            const userData = await response.json();

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (userData.email) {
                document.getElementById('customerEmail').value = userData.email;
                document.getElementById('customerEmail').readOnly = true;
            }
            if (userData.phoneNumber) {
                document.getElementById('customerPhone').value = userData.phoneNumber;
                document.getElementById('customerPhone').readOnly = true;
            }

            showAuthMessage('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserCards();
        }
    } catch (error) {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

    function showAuthMessage(message) {
        const authMessageDiv = document.getElementById('authMessage');
        authMessageDiv.innerHTML = `
            <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
                ${message}
            </div>
        `;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞
    async function submitOrder() {
        if (uploadedPhotos.length === 0) {
            alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –í–°–ï–• —Ñ–æ—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —É—Å–ª—É–≥–∞
        const photosWithoutServices = uploadedPhotos.filter(photo => photo.services.length === 0);
        if (photosWithoutServices.length > 0) {
            const photoNames = photosWithoutServices.map(photo => `"${photo.file.name}"`).join(', ');
            alert(`–î–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —É—Å–ª—É–≥–∏:\n${photoNames}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —ç—Ç–∏ —Ñ–æ—Ç–æ.`);
            return;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const customerEmail = document.getElementById('customerEmail').value;
        const customerPhone = document.getElementById('customerPhone').value;

        if (!customerEmail || !customerPhone) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(customerEmail)) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const submitBtn = document.querySelector('button[onclick="submitOrder()"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '–û—Ñ–æ—Ä–º–ª—è–µ–º –∑–∞–∫–∞–∑...';
        submitBtn.disabled = true;

        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∏ –ø–æ–ª—É—á–∞–µ–º URL
            const uploadedPhotoUrls = [];
            for (const photo of uploadedPhotos) {
                const formData = new FormData();
                formData.append('file', photo.file);

                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ "${photo.file.name}": ${errorText}`);
                }

                const fileName = await uploadResponse.text();
                const fileUrl = `/api/files/${fileName}`;
                uploadedPhotoUrls.push(fileUrl);

                console.log(`–§–æ—Ç–æ "${photo.file.name}" –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞–∫: ${fileName}`);
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
            const orderData = {
                customerEmail: customerEmail,
                customerPhone: customerPhone,
                discountCardCode: appliedDiscountCard ? appliedDiscountCard.code : null,
                couponCode: appliedCoupon ? appliedCoupon.code : null,
                items: uploadedPhotos.map((photo, index) => ({
                    photoUrl: uploadedPhotoUrls[index],
                    services: photo.services.map(service => ({
                        serviceId: service.serviceId,
                        serviceSizeId: service.serviceSizeId,
                        quantity: service.quantity
                    }))
                }))
            };

            console.log('Sending order data:', orderData);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const result = await response.json();
                window.location.href = '/order/success?id=' + result.id;
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }

        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + error.message);
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
 function addMorePhotos() {
    document.getElementById('photoUpload').click();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ª—É–≥ —Å –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ –Ω–∞ –¥—Ä—É–≥–∏–µ
function copyServicesFromPhoto(sourcePhotoId) {
    const sourcePhoto = uploadedPhotos.find(p => p.id === sourcePhotoId);
    if (!sourcePhoto || sourcePhoto.services.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ —Å —É—Å–ª—É–≥–∞–º–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Å–ª—É–≥–∏ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    lastSelectedServices = sourcePhoto.services.map(service => ({
        ...service,
        photoId: sourcePhotoId
    }));

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ñ–æ—Ç–æ
    uploadedPhotos.forEach(photo => {
        if (photo.id !== sourcePhotoId) {
            photo.services = [];
            lastSelectedServices.forEach(service => {
                const serviceCopy = { ...service };
                delete serviceCopy.photoId;
                photo.services.push(serviceCopy);
            });
        }
    });

    updateServicesSelection();
    updatePhotosDisplay();
    calculateTotal();

    alert(`–£—Å–ª—É–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å "${sourcePhoto.file.name}" –Ω–∞ –≤—Å–µ —Ñ–æ—Ç–æ!`);
}

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function initializeUI() {
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ drag and drop –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–æ—Ç–æ
        const dropZone = document.getElementById('photosContainer');
        if (dropZone) {
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');

                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    const input = document.getElementById('photoUpload');
                    input.files = e.dataTransfer.files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', async function() {
        await loadServices();
        await loadUserProfile();
        initializeUI();
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>